# Исследование репликации mongodb из go

для запуска с логами

```
docker-compose up --build
```

для запуска в фоне добавить флаг `-d`

для остановки 
```
docker-compose down
```

контейнер replica через 5 секунд после старта инициализирует replica set, затем каждые 5 секунд опрашивает статус.

для подключения к консоли контейнера `mongo1` (мастера)
```
docker exec -it mongo1 bash 
```
в консоли можно ввести команду `mongo`, а в консоли монго команду `rs.status()`

выход из консоли контейнера командой `exit`

при активных экспериментах место на диске быстро засоряется, для очистки
```
docker rm $(docker ps -a -f status=exited -q)
docker volume rm $(docker volume ls -f dangling=true -q)
```

TODO list
* возможноть чтения (не записи) из слейва, если мастер недоступен. Сейчас даже статус реплики не прочитать.
* `replSetInitiate` должна вызываться только один раз в жизни replica set. Для переинициализации используется 
```java
rs.reconfig
function(cfg, options) {
    cfg.version = rs.conf().version + 1;
    cmd = {replSetReconfig: cfg};
    for (var i in options) {
        cmd[i] = options[i];
    }
    return this._runCmd(cmd);
}
``` 
* чтобы была возможность реконфигурировать со слейва необходимо добавлять force https://docs.mongodb.com/manual/tutorial/reconfigure-replica-set-with-unavailable-members/
* без арбитора не работает вообще. Если остается один сервер монги в реплике, то он всегда слейв. Надо делать реконфиг так, чтобы арьитор всегда работал на мастере.
* сейчас клиент, который пишет по ip в слейв, пишет и в мастер. Хотелось бы, чтобы слейву запись в реплику была запрещена.
* написать ручку, которая определяет кто слейв, кто мастер.
* Первичная инициализация, кто успел того и тапки. Кто не успел, становится слейвом.
